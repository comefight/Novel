<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>星月写作·GitHub版</title>
<style>
body{margin:0;background:#121212;color:#eee;font-family:-apple-system;font-size:16px}header{display:flex;align-items:center;padding:8px 12px;background:#1f1f1f}button{margin-left:6px;padding:6px 12px;border:none;border-radius:4px;background:#1890ff;color:#fff;font-size:14px;cursor:pointer}#box{display:flex;height:calc(100vh - 50px)}#left{width:200px;border-right:1px solid #333;overflow-y:auto}#right{flex:1}#right textarea{width:100%;height:100%;border:0;background:#121212;color:#eee;padding:10px;font-size:16px;outline:0;resize:none}li{cursor:pointer;padding:4px 0}li:hover{background:#2b2b2b}
</style>
</head>
<body>
<header>
  <input id="key" placeholder="你的AI-Key" style="width:200px">
  <select id="api"><option value="ernie">文心</option><option value="openai">OpenAI</option><option value="gemini">Gemini</option></select>
  <button id="genAll">生成全书</button>
  <button id="confirm">确认写第一章</button>
  <button id="review">逻辑审查</button>
  <button id="export">导出TXT</button>
</header>
<div id="box">
  <ul id="left"></ul>
  <textarea id="txt" placeholder="正文区"></textarea>
</div>
<script>
const dbName="novel",storeName="chap";let db,now=1;
const open=indexedDB.open(dbName,1);
open.onupgradeneeded=()=>open.result.createObjectStore(storeName,{keyPath:"id",autoIncrement:true});
open.onsuccess=()=>{db=open.result;loadIndex()};
function tx(m){return db.transaction(storeName,m).objectStore(storeName)}
function put(o){tx("readwrite").put(o)}
function loadIndex(){tx("readonly").getAll().onsuccess=e=>left.innerHTML=e.target.result.map(c=>`<li data-id="${c.id}">${c.t}</li>`).join("")}

genAll.onclick=async()=>{
  if(!key.value)return alert("先填Key");
  const outline=await callAI(`书名：${prompt("书名")||"未命名"}，主角：${prompt("主角名")||"主角"}，关键词：${prompt("3关键词")||"无"}；请生成百万字长篇大纲，按「卷-章-摘要」列表输出，每章摘要100字。`);
  outline.split(/\n/).filter(l=>l).forEach((t,i)=>put({id:i+1,t:t,c:""}));
  loadIndex()
};
confirm.onclick=async()=>{
  const first=await new Promise(res=>tx("readonly").get(1).onsuccess=e=>res(e.target.result));
  if(!first)return alert("先生成全书");
  const text=await callAI(`根据摘要写正文，不解释：${first.t}`);
  txt.value=text; put({id:1,t:first.t,c:text}); txt.focus()
};
review.onclick=async()=>{
  const r=await callAI(`检查下文是否存在前后矛盾，标红指出：\n${txt.value}`);
  txt.value+=`\n\n【逻辑审查】\n${r}`
};
export.onclick=()=>{
  tx("readonly").getAll().onsuccess=e=>{
    const full=e.target.result.map(c=>`【${c.t}】\n${c.c}\n`).join("\n");
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([full],{type:"text/plain"}));
    a.download="novel.txt";a.click()
  }
};
txt.oninput=()=>put({id:now,t:left.children[now-1]?.textContent||"章节",c:txt.value});
left.onclick=e=>if(e.target.tagName==="LI"){now=+e.target.dataset.id;get(now,d=>txt.value=d?d.c:"")}

async function callAI(p){
  const ty=api.value,k=key.value;
  if(ty==="ernie"){
    const tok=await(await fetch(`https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${k.split(":")[0]}&client_secret=${k.split(":")[1]}`)).json();
    const rsp=await(await fetch("https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions?access_token="+tok.access_token,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"user",content:p}]})})).json();
    return rsp.result||rsp.error_msg||"err"
  }
  if(ty==="openai"){
    const rsp=await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+k},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"user",content:p}]})})).json();
    return rsp.choices[0].message.content
  }
  if(ty==="gemini"){
    const rsp=await(await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${k}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:p}]}]})})).json();
    return rsp.candidates[0].content.parts[0].text
  }
}
</script>
</body>
</html>
